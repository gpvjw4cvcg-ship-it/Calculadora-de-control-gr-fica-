<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora de Gráficos de Control</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
            margin: 0;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            padding: 30px;
        }
        
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 10px;
            border-bottom: 2px solid #3498db;
            padding-bottom: 15px;
        }
        
        .subtitle {
            text-align: center;
            color: #7f8c8d;
            margin-bottom: 30px;
        }
        
        .section {
            margin-bottom: 30px;
            padding: 20px;
            border-radius: 8px;
            background-color: #f9f9f9;
        }
        
        .section-title {
            color: #2980b9;
            margin-top: 0;
            border-bottom: 1px solid #ddd;
            padding-bottom: 10px;
        }
        
        .data-input {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .day-data {
            background-color: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.08);
        }
        
        .day-data h3 {
            margin-top: 0;
            color: #3498db;
        }
        
        .measurement-inputs {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        input[type="number"] {
            width: 60px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            text-align: center;
        }
        
        .buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
        }
        
        button {
            padding: 12px 24px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s;
        }
        
        button:hover {
            background-color: #2980b9;
        }
        
        button.reset {
            background-color: #e74c3c;
        }
        
        button.reset:hover {
            background-color: #c0392b;
        }
        
        .results {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .result-card {
            background-color: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.08);
        }
        
        .result-card h4 {
            margin-top: 0;
            color: #2c3e50;
            border-bottom: 1px solid #eee;
            padding-bottom: 8px;
        }
        
        .result-value {
            font-size: 1.5em;
            font-weight: bold;
            color: #3498db;
            text-align: center;
            margin: 10px 0;
        }
        
        .chart-container {
            position: relative;
            height: 400px;
            width: 100%;
            margin-top: 20px;
        }
        
        .interpretation {
            background-color: #e8f4fc;
            padding: 20px;
            border-radius: 8px;
            border-left: 5px solid #3498db;
        }
        
        .interpretation h3 {
            margin-top: 0;
            color: #2c3e50;
        }
        
        .control-status {
            font-weight: bold;
            font-size: 1.2em;
            padding: 10px;
            border-radius: 5px;
            text-align: center;
            margin-top: 15px;
        }
        
        .in-control {
            background-color: #d5f4e6;
            color: #27ae60;
            border: 1px solid #2ecc71;
        }
        
        .out-of-control {
            background-color: #fadbd8;
            color: #e74c3c;
            border: 1px solid #e74c3c;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        th, td {
            padding: 12px 15px;
            text-align: center;
            border-bottom: 1px solid #ddd;
        }
        
        th {
            background-color: #3498db;
            color: white;
        }
        
        tr:hover {
            background-color: #f5f5f5;
        }
        
        .formula {
            font-family: 'Courier New', monospace;
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        
        @media (max-width: 768px) {
            .data-input {
                grid-template-columns: 1fr;
            }
            
            .buttons {
                flex-direction: column;
            }
            
            .chart-container {
                height: 300px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Calculadora de Gráficos de Control X-barra y R</h1>
        <p class="subtitle">Para el monitoreo del diámetro de piezas fabricadas</p>
        
        <div class="section">
            <h2 class="section-title">1. Datos de Entrada</h2>
            <p>Ingrese las mediciones de diámetro (mm) para cada día (5 muestras por día):</p>
            
            <div class="data-input" id="dataInputs">
                <!-- Los inputs se generarán dinámicamente -->
            </div>
            
            <div class="buttons">
                <button id="calculateBtn">Calcular Gráfico de Control</button>
                <button id="resetBtn" class="reset">Reiniciar Datos</button>
                <button id="loadExampleBtn">Cargar Ejemplo</button>
            </div>
        </div>
        
        <div class="section">
            <h2 class="section-title">2. Cálculos y Resultados</h2>
            
            <table id="resultsTable">
                <thead>
                    <tr>
                        <th>Día</th>
                        <th>Mediciones (mm)</th>
                        <th>Media (X̄)</th>
                        <th>Rango (R)</th>
                    </tr>
                </thead>
                <tbody id="resultsBody">
                    <!-- Los resultados se llenarán aquí -->
                </tbody>
            </table>
            
            <div class="results">
                <div class="result-card">
                    <h4>Media Global (X̄̄)</h4>
                    <div class="result-value" id="globalMean">-</div>
                    <p>Línea central del gráfico X-barra</p>
                </div>
                
                <div class="result-card">
                    <h4>Rango Promedio (R̄)</h4>
                    <div class="result-value" id="avgRange">-</div>
                    <p>Línea central del gráfico R</p>
                </div>
                
                <div class="result-card">
                    <h4>Límite Superior de Control (LCS)</h4>
                    <div class="result-value" id="ucl">-</div>
                    <p>Para gráfico X-barra</p>
                </div>
                
                <div class="result-card">
                    <h4>Límite Inferior de Control (LCI)</h4>
                    <div class="result-value" id="lcl">-</div>
                    <p>Para gráfico X-barra</p>
                </div>
            </div>
            
            <div class="formula">
                <strong>Fórmulas utilizadas:</strong><br>
                LCS = X̄̄ + A₂·R̄ &nbsp;&nbsp;|&nbsp;&nbsp; LCI = X̄̄ - A₂·R̄ &nbsp;&nbsp;|&nbsp;&nbsp; A₂ = 0.577 (para n=5)
            </div>
        </div>
        
        <div class="section">
            <h2 class="section-title">3. Gráfico de Control X-barra</h2>
            <div class="chart-container">
                <canvas id="controlChart"></canvas>
            </div>
        </div>
        
        <div class="section">
            <h2 class="section-title">4. Interpretación del Proceso</h2>
            <div class="interpretation">
                <h3>¿El proceso está bajo control estadístico?</h3>
                <p id="interpretationText">Realice los cálculos para obtener la interpretación del proceso.</p>
                <div id="controlStatus" class="control-status">Esperando cálculo...</div>
                
                <h3>Criterios para determinar si un proceso está bajo control:</h3>
                <ul>
                    <li>Todos los puntos están dentro de los límites de control (LCS y LCI)</li>
                    <li>No hay patrones evidentes (tendencias, ciclos, etc.)</li>
                    <li>Los puntos están distribuidos aleatoriamente alrededor de la línea central</li>
                    <li>No hay 7 puntos consecutivos del mismo lado de la línea central</li>
                </ul>
            </div>
        </div>
    </div>

    <script>
        // Datos iniciales del ejemplo
        const exampleData = [
            [10.1, 10.0, 10.2, 9.9, 10.1], // Día 1
            [10.2, 10.1, 9.8, 10.0, 10.1], // Día 2
            [10.0, 9.9, 10.1, 10.2, 10.0], // Día 3
            [9.8, 10.1, 10.0, 10.2, 9.9]   // Día 4
        ];
        
        // Constantes para gráfico X-barra (n=5)
        const A2 = 0.577; // Factor para límites de control con n=5
        
        // Variables globales
        let chart = null;
        let currentData = [];
        
        // Inicializar la aplicación
        document.addEventListener('DOMContentLoaded', function() {
            initializeDataInputs();
            loadExampleData();
            
            // Configurar event listeners
            document.getElementById('calculateBtn').addEventListener('click', calculateControlChart);
            document.getElementById('resetBtn').addEventListener('click', resetData);
            document.getElementById('loadExampleBtn').addEventListener('click', loadExampleData);
        });
        
        // Inicializar los inputs de datos
        function initializeDataInputs() {
            const dataInputsContainer = document.getElementById('dataInputs');
            dataInputsContainer.innerHTML = '';
            
            // Crear inputs para 4 días (puede extenderse)
            for (let day = 1; day <= 4; day++) {
                const dayDiv = document.createElement('div');
                dayDiv.className = 'day-data';
                
                let html = `<h3>Día ${day}</h3>`;
                html += '<div class="measurement-inputs">';
                
                // Crear 5 inputs por día
                for (let i = 1; i <= 5; i++) {
                    html += `<input type="number" step="0.01" min="0" id="day${day}_measure${i}" placeholder="M${i}">`;
                }
                
                html += '</div>';
                dayDiv.innerHTML = html;
                dataInputsContainer.appendChild(dayDiv);
            }
            
            // Inicializar currentData como array vacío
            currentData = [[], [], [], []];
        }
        
        // Cargar datos de ejemplo
        function loadExampleData() {
            for (let day = 1; day <= 4; day++) {
                for (let i = 1; i <= 5; i++) {
                    const input = document.getElementById(`day${day}_measure${i}`);
                    if (input) {
                        input.value = exampleData[day-1][i-1];
                    }
                }
            }
            
            // Calcular automáticamente con los datos de ejemplo
            setTimeout(calculateControlChart, 100);
        }
        
        // Reiniciar datos a vacío
        function resetData() {
            for (let day = 1; day <= 4; day++) {
                for (let i = 1; i <= 5; i++) {
                    const input = document.getElementById(`day${day}_measure${i}`);
                    if (input) {
                        input.value = '';
                    }
                }
            }
            
            // Limpiar resultados
            document.getElementById('resultsBody').innerHTML = '';
            document.getElementById('globalMean').textContent = '-';
            document.getElementById('avgRange').textContent = '-';
            document.getElementById('ucl').textContent = '-';
            document.getElementById('lcl').textContent = '-';
            document.getElementById('interpretationText').textContent = 'Realice los cálculos para obtener la interpretación del proceso.';
            document.getElementById('controlStatus').textContent = 'Esperando cálculo...';
            document.getElementById('controlStatus').className = 'control-status';
            
            // Limpiar gráfico
            if (chart) {
                chart.destroy();
            }
            
            // Reiniciar currentData
            currentData = [[], [], [], []];
        }
        
        // Calcular el gráfico de control
        function calculateControlChart() {
            // Obtener datos de los inputs
            currentData = [];
            let allDataValid = true;
            
            for (let day = 1; day <= 4; day++) {
                const dayData = [];
                
                for (let i = 1; i <= 5; i++) {
                    const input = document.getElementById(`day${day}_measure${i}`);
                    const value = parseFloat(input.value);
                    
                    if (isNaN(value)) {
                        allDataValid = false;
                        input.style.borderColor = '#e74c3c';
                    } else {
                        dayData.push(value);
                        input.style.borderColor = '#ddd';
                    }
                }
                
                // Si no hay 5 valores válidos, usar NaN para indicar error
                if (dayData.length < 5) {
                    allDataValid = false;
                }
                
                currentData.push(dayData);
            }
            
            if (!allDataValid) {
                alert('Por favor, ingrese 5 valores numéricos válidos para cada día.');
                return;
            }
            
            // Calcular medias y rangos por día
            const dailyMeans = [];
            const dailyRanges = [];
            
            for (let i = 0; i < currentData.length; i++) {
                const dayData = currentData[i];
                
                // Calcular media del día
                const sum = dayData.reduce((acc, val) => acc + val, 0);
                const mean = sum / dayData.length;
                dailyMeans.push(mean);
                
                // Calcular rango del día
                const max = Math.max(...dayData);
                const min = Math.min(...dayData);
                const range = max - min;
                dailyRanges.push(range);
            }
            
            // Calcular media global y rango promedio
            const globalMean = dailyMeans.reduce((acc, val) => acc + val, 0) / dailyMeans.length;
            const avgRange = dailyRanges.reduce((acc, val) => acc + val, 0) / dailyRanges.length;
            
            // Calcular límites de control
            const ucl = globalMean + A2 * avgRange; // Límite superior de control
            const lcl = globalMean - A2 * avgRange; // Límite inferior de control
            
            // Mostrar resultados en la tabla
            displayResultsTable(currentData, dailyMeans, dailyRanges);
            
            // Mostrar resultados numéricos
            document.getElementById('globalMean').textContent = globalMean.toFixed(3);
            document.getElementById('avgRange').textContent = avgRange.toFixed(3);
            document.getElementById('ucl').textContent = ucl.toFixed(3);
            document.getElementById('lcl').textContent = lcl.toFixed(3);
            
            // Crear gráfico
            createControlChart(dailyMeans, globalMean, ucl, lcl);
            
            // Interpretar resultados
            interpretResults(dailyMeans, ucl, lcl);
        }
        
        // Mostrar resultados en la tabla
        function displayResultsTable(data, means, ranges) {
            const resultsBody = document.getElementById('resultsBody');
            let html = '';
            
            for (let i = 0; i < data.length; i++) {
                const dayNumber = i + 1;
                const measurements = data[i].map(val => val.toFixed(1)).join(', ');
                const mean = means[i].toFixed(3);
                const range = ranges[i].toFixed(3);
                
                html += `
                    <tr>
                        <td>${dayNumber}</td>
                        <td>${measurements}</td>
                        <td>${mean}</td>
                        <td>${range}</td>
                    </tr>
                `;
            }
            
            resultsBody.innerHTML = html;
        }
        
        // Crear gráfico de control
        function createControlChart(dailyMeans, globalMean, ucl, lcl) {
            const ctx = document.getElementById('controlChart').getContext('2d');
            
            // Destruir gráfico anterior si existe
            if (chart) {
                chart.destroy();
            }
            
            // Preparar datos para el gráfico
            const days = ['Día 1', 'Día 2', 'Día 3', 'Día 4'];
            
            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: days,
                    datasets: [
                        {
                            label: 'Media por día (X̄)',
                            data: dailyMeans,
                            borderColor: '#3498db',
                            backgroundColor: 'rgba(52, 152, 219, 0.1)',
                            borderWidth: 2,
                            fill: false,
                            tension: 0.1,
                            pointRadius: 6,
                            pointBackgroundColor: '#3498db'
                        },
                        {
                            label: 'Línea Central (X̄̄)',
                            data: Array(dailyMeans.length).fill(globalMean),
                            borderColor: '#2ecc71',
                            borderWidth: 2,
                            borderDash: [5, 5],
                            fill: false,
                            pointRadius: 0
                        },
                        {
                            label: 'LCS',
                            data: Array(dailyMeans.length).fill(ucl),
                            borderColor: '#e74c3c',
                            borderWidth: 2,
                            borderDash: [5, 5],
                            fill: false,
                            pointRadius: 0
                        },
                        {
                            label: 'LCI',
                            data: Array(dailyMeans.length).fill(lcl),
                            borderColor: '#e74c3c',
                            borderWidth: 2,
                            borderDash: [5, 5],
                            fill: false,
                            pointRadius: 0
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: false,
                            title: {
                                display: true,
                                text: 'Diámetro (mm)'
                            },
                            min: Math.min(lcl, ...dailyMeans) - 0.1,
                            max: Math.max(ucl, ...dailyMeans) + 0.1
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Días'
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    label += context.parsed.y.toFixed(3) + ' mm';
                                    return label;
                                }
                            }
                        },
                        legend: {
                            position: 'top',
                        }
                    }
                }
            });
        }
        
        // Interpretar resultados
        function interpretResults(dailyMeans, ucl, lcl) {
            let allPointsInControl = true;
            let patternDetected = false;
            let interpretationText = '';
            
            // Verificar si todos los puntos están dentro de los límites
            for (let i = 0; i < dailyMeans.length; i++) {
                if (dailyMeans[i] > ucl || dailyMeans[i] < lcl) {
                    allPointsInControl = false;
                    interpretationText += `• El punto del Día ${i+1} (${dailyMeans[i].toFixed(3)}) está fuera de los límites de control.<br>`;
                }
            }
            
            // Verificar si hay 7 puntos consecutivos del mismo lado (aunque solo tenemos 4 puntos)
            // Esta verificación sería más relevante con más datos
            
            // Verificar tendencias (si hubiera más datos)
            if (dailyMeans.length >= 3) {
                // Verificar si hay tendencia creciente o decreciente
                let increasingCount = 0;
                let decreasingCount = 0;
                
                for (let i = 1; i < dailyMeans.length; i++) {
                    if (dailyMeans[i] > dailyMeans[i-1]) increasingCount++;
                    if (dailyMeans[i] < dailyMeans[i-1]) decreasingCount++;
                }
                
                // Si todos los puntos son crecientes o decrecientes
                if (increasingCount === dailyMeans.length - 1) {
                    patternDetected = true;
                    interpretationText += '• Se detectó una tendencia creciente en todos los puntos.<br>';
                } else if (decreasingCount === dailyMeans.length - 1) {
                    patternDetected = true;
                    interpretationText += '• Se detectó una tendencia decreciente en todos los puntos.<br>';
                }
            }
            
            // Determinar estado del proceso
            const controlStatus = document.getElementById('controlStatus');
            const statusText = document.getElementById('interpretationText');
            
            if (allPointsInControl && !patternDetected) {
                controlStatus.textContent = '✓ EL PROCESO ESTÁ BAJO CONTROL';
                controlStatus.className = 'control-status in-control';
                
                if (interpretationText === '') {
                    interpretationText = 'Todos los puntos están dentro de los límites de control y no se detectaron patrones especiales.';
                }
            } else {
                controlStatus.textContent = '✗ EL PROCESO NO ESTÁ BAJO CONTROL';
                controlStatus.className = 'control-status out-of-control';
                
                if (interpretationText === '') {
                    interpretationText = 'Se detectaron patrones especiales o puntos fuera de los límites de control.';
                }
            }
            
            statusText.innerHTML = interpretationText;
        }
    </script>
</body>
</html>
